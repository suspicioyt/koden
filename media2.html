<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kode≈Ñ Media</title>
    <link rel="icon" href="https://via.placeholder.com/32" type="image/png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #121212;
            --text-color: #ffffff;
            --card-bg: #1e1e1e;
            --accent-color: #ff2e63;
            --accent-hover: #ff5c8d;
            --secondary-bg: rgba(18, 18, 18, 0.95);
            --gradient-overlay: linear-gradient(to bottom, rgba(0,0,0,0.3), rgba(0,0,0,0.8));
        }

        [data-theme="light"] {
            --bg-color: #ffffff;
            --text-color: #121212;
            --card-bg: #f5f5f5;
            --secondary-bg: rgba(255, 255, 255, 0.95);
        }

        [data-theme="high-contrast"] {
            --bg-color: #000000;
            --text-color: #ffffff;
            --card-bg: #333333;
            --accent-color: #ffff00;
            --accent-hover: #cccc00;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            overflow-x: hidden;
            transition: background 0.3s ease, color 0.3s ease;
        }

        header {
            position: fixed;
            top: 0;
            width: 100%;
            background: var(--secondary-bg);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(12px);
        }

        .logo {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--accent-color);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        nav {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .search-bar {
            position: relative;
        }

        .search-bar input {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.15);
            color: var(--text-color);
            font-size: 0.9rem;
            width: 200px;
            transition: width 0.3s ease, background 0.3s ease;
        }

        .search-bar input:focus {
            outline: none;
            width: 250px;
            background: rgba(255, 255, 255, 0.25);
        }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .avatar:hover {
            transform: scale(1.1);
        }

        .dropdown {
            display: none;
            position: absolute;
            top: 60px;
            right: 20px;
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.5);
            min-width: 180px;
            z-index: 1001;
        }

        .dropdown.active {
            display: block;
            animation: slideIn 0.2s ease-out;
        }

        .dropdown button {
            width: 100%;
            padding: 0.75rem 1rem;
            background: none;
            border: none;
            color: var(--text-color);
            text-align: left;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .dropdown button:hover {
            background: var(--accent-color);
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: var(--bg-color);
        }

        .login-box {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 12px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
            transition: transform 0.3s ease;
            text-align: center;
        }

        .login-box:hover {
            transform: translateY(-5px);
        }

        .login-box h1 {
            font-size: 2rem;
            margin-bottom: 1.5rem;
            font-weight: 600;
        }

        .login-box input {
            width: 100%;
            padding: 0.75rem;
            margin: 0.5rem 0;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
            font-size: 1rem;
            transition: background 0.3s ease, box-shadow 0.3s ease;
        }

        .login-box input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 0 0 3px var(--accent-color);
        }

        .login-box button {
            width: 100%;
            padding: 0.75rem;
            background: var(--accent-color);
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .login-box button:hover {
            background: var(--accent-hover);
            transform: translateY(-2px);
        }

        .login-box button:disabled {
            background: #b30710;
            cursor: not-allowed;
        }

        .spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 3px solid #fff;
            border-top: 3px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .login-box button.loading .spinner {
            display: inline-block;
        }

        .login-box button.loading span {
            display: none;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error {
            color: #f40612;
            margin-top: 1rem;
            font-size: 0.9rem;
            display: none;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .content-container {
            display: none;
            padding: 5rem 2rem 2rem;
            min-height: 100vh;
            transition: opacity 0.3s ease;
        }

        .content-container.active {
            display: block;
            opacity: 1;
        }

        .content-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 500;
        }

        .content-loading.active {
            display: flex;
        }

        .content-loading .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--accent-color);
            border-top: 5px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .progress-bar {
            width: 200px;
            height: 6px;
            background: #333;
            border-radius: 4px;
            margin-top: 1rem;
            overflow: hidden;
        }

        .progress-bar div {
            width: 0;
            height: 100%;
            background: var(--accent-color);
            transition: width 0.1s linear;
        }

        .section {
            margin: 2rem 0;
            transition: opacity 0.3s ease;
        }

        .section h2 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .carousel-container {
            position: relative;
        }

        .carousel {
            display: flex;
            overflow-x: auto;
            gap: 1rem;
            padding: 1rem 0;
            scroll-behavior: smooth;
            scrollbar-width: none;
        }

        .carousel::-webkit-scrollbar {
            display: none;
        }

        .carousel-nav {
            position: absolute;
            top: 50%;
            width: 100%;
            display: flex;
            justify-content: space-between;
            transform: translateY(-50%);
            pointer-events: none;
        }

        .carousel-nav button {
            background: rgba(0, 0, 0, 0.6);
            border: none;
            color: #fff;
            font-size: 1.2rem;
            padding: 0.5rem;
            cursor: pointer;
            border-radius: 50%;
            transition: background 0.3s ease;
            pointer-events: auto;
        }

        .carousel-nav button:hover {
            background: var(--accent-color);
        }

        .carousel-nav button:disabled {
            background: rgba(0, 0, 0, 0.2);
            cursor: not-allowed;
        }

        .item {
            position: relative;
            background: var(--card-bg);
            border-radius: 10px;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            flex: 0 0 220px;
            height: 160px;
        }

        .item:hover {
            transform: translateY(-8px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6);
        }

        #liveContent .item,
        #recentlyViewedContent .item,
        #moviesContent .item,
        #musicContent .item {
            flex: 0 0 220px;
            height: 160px;
        }

        #booksContent .item {
            flex: 0 0 140px;
            height: 220px;
        }

        [data-view="compact"] #liveContent .item,
        [data-view="compact"] #recentlyViewedContent .item,
        [data-view="compact"] #moviesContent .item,
        [data-view="compact"] #musicContent .item {
            flex: 0 0 160px;
            height: 120px;
        }

        [data-view="compact"] #booksContent .item {
            flex: 0 0 100px;
            height: 160px;
        }

        .item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 10px;
            position: relative;
            z-index: 1;
        }

        .item p {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--gradient-overlay);
            color: var(--text-color);
            font-size: 0.9rem;
            padding: 0.5rem;
            text-align: center;
            font-weight: 500;
            z-index: 3;
        }

        .item .highlight {
            background: rgba(255, 255, 0, 0.3);
        }

        .item .favorite {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.7);
            border: none;
            color: #fff;
            font-size: 1.2rem;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 50%;
            z-index: 3;
        }

        .item .favorite.favorited {
            color: var(--accent-color);
        }

        .item .tooltip {
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--card-bg);
            color: var(--text-color);
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.85rem;
            white-space: nowrap;
            z-index: 4;
            display: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
        }

        .item:hover .tooltip {
            display: block;
        }

        .item.premium-placeholder {
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .item.premium-placeholder .premium-lock {
            color: #fff;
            font-size: 0.9rem;
            font-weight: bold;
            background: rgba(0, 0, 0, 0.9);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            text-align: center;
        }

        .live-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            background: #ff0000;
            color: #fff;
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            z-index: 3;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-content {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 12px;
            max-width: 800px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
            position: relative;
            animation: scaleIn 0.3s ease-out;
        }

        @keyframes scaleIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .modal-content h2 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .modal-content video,
        .modal-content audio,
        .modal-content iframe {
            width: 100%;
            border-radius: 8px;
        }

        .modal-content audio {
            height: 50px;
        }

        .modal-content iframe {
            height: 400px;
        }

        #pdfViewer {
            width: 100%;
            height: 500px;
            border: none;
            background: #fff;
            border-radius: 8px;
        }

        .pdf-controls {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
            justify-content: center;
            align-items: center;
        }

        .pdf-controls button {
            padding: 0.5rem 1rem;
            background: var(--accent-color);
            border: none;
            color: #fff;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .pdf-controls button:hover {
            background: var(--accent-hover);
        }

        .pdf-controls button:disabled {
            background: #b30710;
            cursor: not-allowed;
        }

        .close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: var(--accent-color);
            border: none;
            color: #fff;
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .close-btn:hover {
            background: var(--accent-hover);
        }

        .loading-overlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            border-radius: 8px;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 5px solid var(--accent-color);
            border-top: 5px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #f40612;
            color: #fff;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            z-index: 2000;
            display: none;
            animation: toastIn 0.3s ease;
        }

        .toast.active {
            display: block;
        }

        @keyframes toastIn {
            from { opacity: 0; transform: translateX(-50%) translateY(20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        #searchResults {
            position: absolute;
            top: 60px;
            left: 20px;
            color: var(--text-color);
            font-size: 0.9rem;
        }

        .settings-modal .theme-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }

        .settings-modal .theme-preview {
            width: 100%;
            height: 80px;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s ease;
            border: 2px solid transparent;
        }

        .settings-modal .theme-preview:hover {
            transform: scale(1.05);
        }

        .settings-modal .theme-preview.selected {
            border-color: var(--accent-color);
        }

        .settings-modal .theme-dark {
            background: #121212;
        }

        .settings-modal .theme-light {
            background: #ffffff;
        }

        .settings-modal .theme-high-contrast {
            background: #000000;
        }

        .settings-modal .toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .settings-modal .toggle input {
            width: 40px;
            height: 20px;
            appearance: none;
            background: #333;
            border-radius: 20px;
            position: relative;
            cursor: pointer;
        }

        .settings-modal .toggle input:checked {
            background: var(--accent-color);
        }

        .settings-modal .toggle input::before {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            background: #fff;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.2s ease;
        }

        .settings-modal .toggle input:checked::before {
            transform: translateX(20px);
        }

        .profile-modal form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .profile-modal label {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .profile-modal input {
            padding: 0.5rem;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
            font-size: 0.9rem;
        }

        .profile-modal input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 0 0 3px var(--accent-color);
        }

        .profile-modal button[type="submit"] {
            background: var(--accent-color);
            border: none;
            color: #fff;
            padding: 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .profile-modal button[type="submit"]:hover {
            background: var(--accent-hover);
        }

        @media (max-width: 768px) {
            header { padding: 1rem; }
            .logo { font-size: 1.4rem; }
            nav { gap: 0.75rem; }
            .search-bar input { width: 150px; }
            .search-bar input:focus { width: 200px; }
            .avatar { width: 32px; height: 32px; font-size: 0.9rem; }
            .dropdown { top: 50px; right: 10px; }
            .content-container { padding: 4rem 1rem 1rem; }
            .login-box { padding: 1.5rem; max-width: 90%; }
            .section h2 { font-size: 1.3rem; }
            #liveContent .item,
            #recentlyViewedContent .item,
            #moviesContent .item,
            #musicContent .item { flex: 0 0 180px; height: 130px; }
            #booksContent .item { flex: 0 0 120px; height: 180px; }
            [data-view="compact"] #liveContent .item,
            [data-view="compact"] #recentlyViewedContent .item,
            [data-view="compact"] #moviesContent .item,
            [data-view="compact"] #musicContent .item { flex: 0 0 140px; height: 100px; }
            [data-view="compact"] #booksContent .item { flex: 0 0 90px; height: 140px; }
            .modal-content { padding: 1rem; max-width: 90%; }
            .modal-content iframe { height: 300px; }
            #pdfViewer { height: 400px; }
            .settings-modal .theme-grid { grid-template-columns: 1fr; }
        }

        @media (max-width: 480px) {
            header { padding: 0.75rem; flex-direction: column; gap: 0.5rem; }
            nav { gap: 0.5rem; flex-wrap: wrap; }
            .search-bar input { width: 120px; }
            .search-bar input:focus { width: 160px; }
            .login-box { padding: 1rem; }
            #liveContent .item,
            #recentlyViewedContent .item,
            #moviesContent .item,
            #musicContent .item { flex: 0 0 140px; height: 100px; }
            #booksContent .item { flex: 0 0 100px; height: 160px; }
            [data-view="compact"] #liveContent .item,
            [data-view="compact"] #recentlyViewedContent .item,
            [data-view="compact"] #moviesContent .item,
            [data-view="compact"] #musicContent .item { flex: 0 0 100px; height: 80px; }
            [data-view="compact"] #booksContent .item { flex: 0 0 80px; height: 120px; }
            .modal-content iframe { height: 200px; }
            #pdfViewer { height: 300px; }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo" role="img" aria-label="Logo Kode≈Ñ Media">Kode≈Ñ Media</div>
        <nav role="navigation" aria-label="G≈Ç√≥wna nawigacja">
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="Szukaj..." aria-label="Wyszukaj filmy, muzykƒô, ksiƒÖ≈ºki lub transmisje na ≈ºywo">
            </div>
            <div class="avatar" id="avatar" role="button" tabindex="0" aria-label="Menu u≈ºytkownika" aria-haspopup="true"></div>
            <div class="dropdown" id="dropdown" role="menu">
                <button role="menuitem" aria-label="Profil">Profil</button>
                <button role="menuitem" aria-label="Ustawienia">Ustawienia</button>
                <button role="menuitem" aria-label="Ulubione">Ulubione</button>
                <button role="menuitem" aria-label="Wyloguj siƒô">Wyloguj</button>
            </div>
        </nav>
    </header>

    <div class="login-container" id="loginContainer" role="main" aria-label="Ekran logowania">
        <div class="login-box">
            <h1>Kode≈Ñ Media</h1>
            <input type="text" id="username" placeholder="Login" required aria-label="Nazwa u≈ºytkownika">
            <input type="password" id="password" placeholder="Has≈Ço" required aria-label="Has≈Ço">
            <button id="loginButton" tabindex="0" aria-label="Zaloguj siƒô">
                <span>Zaloguj</span>
                <span class="spinner"></span>
            </button>
            <p class="error" id="errorMessage" role="alert" aria-live="assertive"></p>
        </div>
    </div>

    <div class="content-container" id="contentContainer" role="main" aria-label="Tre≈õci multimedialne">
        <div class="content-loading" id="contentLoading">
            <div class="loading-spinner"></div>
            <div class="progress-bar"><div id="progressBar"></div></div>
        </div>
        <div class="section" id="live" role="region" aria-label="Sekcja Transmisje na ≈ºywo">
            <h2>Transmisje na ≈ºywo</h2>
            <div class="carousel-container">
                <div class="carousel" id="liveContent" tabindex="0" aria-label="Karuzela transmisji na ≈ºywo"></div>
                <div class="carousel-nav">
                    <button class="carousel-prev" aria-label="Poprzedni element">‚óÑ</button>
                    <button class="carousel-next" aria-label="Nastƒôpny element">‚ñ∫</button>
                </div>
            </div>
        </div>
        <div class="section" id="recentlyViewed" role="region" aria-label="Ostatnio oglƒÖdane">
            <h2>Ostatnio oglƒÖdane</h2>
            <div class="carousel-container">
                <div class="carousel" id="recentlyViewedContent" tabindex="0" aria-label="Karuzela ostatnio oglƒÖdanych"></div>
                <div class="carousel-nav">
                    <button class="carousel-prev" aria-label="Poprzedni element">‚óÑ</button>
                    <button class="carousel-next" aria-label="Nastƒôpny element">‚ñ∫</button>
                </div>
            </div>
        </div>
        <div class="section" id="movies" role="region" aria-label="Sekcja Filmy">
            <h2>Filmy</h2>
            <div class="carousel-container">
                <div class="carousel" id="moviesContent" tabindex="0" aria-label="Karuzela film√≥w"></div>
                <div class="carousel-nav">
                    <button class="carousel-prev" aria-label="Poprzedni element">‚óÑ</button>
                    <button class="carousel-next" aria-label="Nastƒôpny element">‚ñ∫</button>
                </div>
            </div>
        </div>
        <div class="section" id="music" role="region" aria-label="Sekcja Muzyka">
            <h2>Muzyka</h2>
            <div class="carousel-container">
                <div class="carousel" id="musicContent" tabindex="0" aria-label="Karuzela muzyki"></div>
                <div class="carousel-nav">
                    <button class="carousel-prev" aria-label="Poprzedni element">‚óÑ</button>
                    <button class="carousel-next" aria-label="Nastƒôpny element">‚ñ∫</button>
                </div>
            </div>
        </div>
        <div class="section" id="books" role="region" aria-label="Sekcja KsiƒÖ≈ºki">
            <h2>KsiƒÖ≈ºki</h2>
            <div class="carousel-container">
                <div class="carousel" id="booksContent" tabindex="0" aria-label="Karuzela ksiƒÖ≈ºek"></div>
                <div class="carousel-nav">
                    <button class="carousel-prev" aria-label="Poprzedni element">‚óÑ</button>
                    <button class="carousel-next" aria-label="Nastƒôpny element">‚ñ∫</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="mediaModal" role="dialog" aria-label="Odtwarzacz multimedi√≥w">
        <div class="modal-content">
            <h2 id="modalTitle"></h2>
            <div id="mediaPlayer"></div>
            <div id="pdfViewerContainer" style="display: none; position: relative;">
                <div class="loading-overlay" id="pdfLoadingOverlay">
                    <div class="loading-spinner"></div>
                </div>
                <canvas id="pdfViewer"></canvas>
                <div class="pdf-controls">
                    <button onclick="previousPage()" aria-label="Poprzednia strona">Poprzednia</button>
                    <span id="pageInfo"></span>
                    <button onclick="nextPage()" aria-label="Nastƒôpna strona">Nastƒôpna</button>
                </div>
            </div>
            <button class="close-btn" tabindex="0" aria-label="Zamknij odtwarzacz">Zamknij</button>
        </div>
    </div>

    <div class="modal" id="settingsModal" role="dialog" aria-label="Ustawienia">
        <div class="modal-content settings-modal">
            <h2>Ustawienia</h2>
            <div class="theme-grid">
                <div class="theme-preview theme-dark" data-theme="dark" role="button" aria-label="Motyw ciemny"></div>
                <div class="theme-preview theme-light" data-theme="light" role="button" aria-label="Motyw jasny"></div>
                <div class="theme-preview theme-high-contrast" data-theme="high-contrast" role="button" aria-label="Motyw wysokiego kontrastu"></div>
            </div>
            <div class="toggle">
                <label for="compactView">Kompaktowy widok</label>
                <input type="checkbox" id="compactView" aria-label="W≈ÇƒÖcz kompaktowy widok">
            </div>
            <div class="toggle">
                <label for="favoritesOnly">Poka≈º tylko ulubione</label>
                <input type="checkbox" id="favoritesOnly" aria-label="Poka≈º tylko ulubione elementy">
            </div>
            <button class="close-btn" tabindex="0" aria-label="Zamknij ustawienia">Zamknij</button>
        </div>
    </div>

    <div class="modal" id="profileModal" role="dialog" aria-label="Profil u≈ºytkownika">
        <div class="modal-content profile-modal">
            <h2>Profil</h2>
            <form id="profileForm">
                <label for="profileAvatar">Kolor awatara</label>
                <input type="color" id="profileAvatar" aria-label="Kolor t≈Ça awatara">
                <button type="submit" aria-label="Zapisz profil">Zapisz</button>
            </form>
            <button class="close-btn" tabindex="0" aria-label="Zamknij profil">Zamknij</button>
        </div>
    </div>

    <div class="toast" id="toast"></div>
    <div id="searchResults" role="status" aria-live="polite"></div>
    <script>
const SCRIPT_URL = 'https://api.allorigins.win/raw?url=https://script.google.com/macros/s/AKfycbwj5uMxgC84cRBajpGAJ_nZ1XBKbSNjlOAid4fwUyxJFBlUqeT7-Ae6Tszv3doMpRPsfQ/exec';
        let apiData = { films: [], music: [], books: [], live: [] };
        let userData = { premium: false, access: false, username: '', email: '', avatarColor: '' };
        let pdfDoc = null;
        let pageNum = 1;
        let pageRendering = false;
        let pageNumPending = null;
        let canvas = null;
        let ctx = null;
        let favorites = JSON.parse(localStorage.getItem('favorites')) || {};
        let recentlyViewed = JSON.parse(localStorage.getItem('recentlyViewed')) || [];

        const fallbackData = {
            films: [
                { title: 'Przyk≈Çadowy Film', imageUrl: 'https://via.placeholder.com/220x160', url: 'https://www.youtube.com/embed/dQw4w9WgXcQ', isPremium: false, description: 'Przyk≈Çadowy opis filmu', category: 'films' }
            ],
            music: [
                { title: 'Przyk≈Çadowa Muzyka', imageUrl: 'https://via.placeholder.com/220x160', url: '', youtubeId: 'dQw4w9WgXcQ', isPremium: false, description: 'Przyk≈Çadowy opis muzyki', category: 'music' }
            ],
            books: [
                { title: 'Przyk≈Çadowa KsiƒÖ≈ºka', imageUrl: 'https://via.placeholder.com/140x220', url: 'https://mozilla.github.io/pdf.js/web/compressed.tracemonkey-pldi-09.pdf', isPremium: false, description: 'Przyk≈Çadowy opis ksiƒÖ≈ºki', category: 'books' }
            ],
            live: [
                { title: 'Przyk≈Çadowa Transmisja', imageUrl: 'https://via.placeholder.com/220x160', url: 'https://www.youtube.com/embed/dQw4w9WgXcQ', isPremium: false, description: 'Przyk≈Çadowa transmisja na ≈ºywo', category: 'live', liveStatus: 'active' }
            ]
        };

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('active');
            setTimeout(() => toast.classList.remove('active'), 3000);
        }

        function generateAvatar() {
            const avatar = document.getElementById('avatar');
            const { username, avatarColor } = userData;
            const firstLetter = username.charAt(0).toUpperCase() || 'U';
            avatar.textContent = firstLetter;
            avatar.style.backgroundColor = avatarColor || '#ff2e63';
            avatar.style.color = '#fff';
        }

        function toggleDropdown() {
            const dropdown = document.getElementById('dropdown');
            dropdown.classList.toggle('active');
            if (dropdown.classList.contains('active')) {
                dropdown.querySelector('button').focus();
            }
        }

        function openSettingsModal() {
            const modal = document.getElementById('settingsModal');
            const compactView = document.getElementById('compactView');
            const favoritesOnly = document.getElementById('favoritesOnly');
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
            const currentView = document.documentElement.getAttribute('data-view') || 'full';
            const isFavoritesOnly = localStorage.getItem('favoritesOnly') === 'true';

            document.querySelectorAll('.theme-preview').forEach(preview => {
                preview.classList.toggle('selected', preview.dataset.theme === currentTheme);
            });

            compactView.checked = currentView === 'compact';
            favoritesOnly.checked = isFavoritesOnly;

            modal.style.display = 'flex';
            modal.focus();
            toggleDropdown();
        }

        function openProfileModal() {
    const modal = document.getElementById('profileModal');
    const avatarInput = document.getElementById('profileAvatar');
    avatarInput.value = userData.avatarColor || '#ff2e63';
    modal.style.display = 'flex';
    modal.focus();
    toggleDropdown();
}

        async function saveProfile(e) {
    e.preventDefault();
    const avatarColor = document.getElementById('profileAvatar').value;
    try {
        const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ endpoint: 'updateProfile', username: userData.username, avatarColor })
        });
        const result = await response.text().then(text => JSON.parse(text || '{}'));
        if (result.success) {
            userData.avatarColor = avatarColor;
            generateAvatar();
            showToast('Profil zaktualizowany pomy≈õlnie');
            closeProfileModal();
        } else {
            showToast('Nie uda≈Ço siƒô zaktualizowaƒá profilu');
        }
    } catch (error) {
        showToast('B≈ÇƒÖd po≈ÇƒÖczenia. Spr√≥buj ponownie.');
        console.error('B≈ÇƒÖd zapisu profilu:', error);
    }
}
function sanitizeInput(input) {
    return input.replace(/[<>"'&]/g, '');
}
async function login() {
    const username = sanitizeInput(document.getElementById('username').value.trim());
    const password = document.getElementById('password').value;
    const errorMessage = document.getElementById('errorMessage');
    const loginButton = document.getElementById('loginButton');

    if (!username || !password) {
        errorMessage.textContent = 'Wype≈Çnij wszystkie pola';
        errorMessage.style.display = 'block';
        console.log('Login failed: Empty username or password');
        return;
    }

    loginButton.disabled = true;
    loginButton.classList.add('loading');

    const payload = { endpoint: 'login', username, password };
    console.log('Sending login request:', JSON.stringify(payload));

    try {
        const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        console.log('Response status:', response.status);
        console.log('Response ok:', response.ok);
        const text = await response.text();
        console.log('Raw response:', text || 'EMPTY RESPONSE');
        let result;
        try {
            result = text ? JSON.parse(text) : { success: false, message: 'Empty response from server' };
        } catch (e) {
            console.log('Failed to parse response:', e.message);
            result = { success: false, message: 'Invalid response format: ' + e.message };
        }
        console.log('Parsed response:', result);

        loginButton.disabled = false;
        loginButton.classList.remove('loading');

        if (result.success && result.access) {
            userData = { premium: result.premium, access: true, username, avatarColor: result.avatarColor };
            console.log('Login successful, userData:', userData);
            generateAvatar();
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('contentContainer').style.display = 'block';
            document.getElementById('contentContainer').classList.add('active');
            document.getElementById('avatar').style.display = 'flex';
            errorMessage.style.display = 'none';
            loadContent();
        } else {
            errorMessage.textContent = result.access === false ? 'Konto zablokowane' : result.message || 'Nieprawid≈Çowy login lub has≈Ço';
            errorMessage.style.display = 'block';
            showToast(result.access === false ? 'Twoje konto jest zablokowane.' : result.message || 'Nieprawid≈Çowy login lub has≈Ço.');
            console.log('Login failed:', result.message || 'No message provided');
        }
    } catch (error) {
        loginButton.disabled = false;
        loginButton.classList.remove('loading');
        errorMessage.textContent = 'B≈ÇƒÖd po≈ÇƒÖczenia';
        errorMessage.style.display = 'block';
        showToast('Nie mo≈ºna zalogowaƒá. Spr√≥buj ponownie.');
        console.error('Login error:', error.message);
    }
}
        function logout() {
            userData = { premium: false, access: false, username: '', email: '', avatarColor: '' };
            document.getElementById('contentContainer').style.display = 'none';
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('avatar').style.display = 'none';
            document.getElementById('dropdown').classList.remove('active');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('errorMessage').style.display = 'none';
            apiData = { films: [], music: [], books: [], live: [] };
            document.querySelectorAll('.carousel').forEach(carousel => carousel.innerHTML = '');
            localStorage.removeItem('favorites');
            localStorage.removeItem('recentlyViewed');
            localStorage.removeItem('contentCache');
            favorites = {};
            recentlyViewed = [];
        }

        async function loadContent() {
    const contentLoading = document.getElementById('contentLoading');
    const progressBar = document.getElementById('progressBar');
    contentLoading.classList.add('active');

    let progress = 0;
    const progressInterval = setInterval(() => {
        progress += 10;
        progressBar.style.width = `${Math.min(progress, 90)}%`;
    }, 500);

    const cachedData = localStorage.getItem('contentCache');
    const cacheTimestamp = localStorage.getItem('contentCacheTimestamp');
    const cacheAge = cacheTimestamp ? (Date.now() - parseInt(cacheTimestamp)) / 1000 / 60 / 60 : Infinity;

    if (cachedData && cacheAge < 1) {
        apiData = JSON.parse(cachedData);
        renderContent();
        clearInterval(progressInterval);
        progressBar.style.width = '100%';
        setTimeout(() => contentLoading.classList.remove('active'), 300);
        return;
    }

    try {
        const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ endpoint: 'content', premium: userData.premium })
        });
        const result = await response.text().then(text => JSON.parse(text || '{}'));

        if (result.success && result.data) {
            apiData = result.data;
            if (!userData.premium) {
                Object.keys(apiData).forEach(section => {
                    apiData[section] = apiData[section].map(item =>
                        item.isPremium ? { isPremium: true, placeholder: true, title: '', imageUrl: '' } : item
                    );
                });
            }
            localStorage.setItem('contentCache', JSON.stringify(apiData));
            localStorage.setItem('contentCacheTimestamp', Date.now().toString());
        } else {
            apiData = fallbackData;
            showToast('Nie uda≈Ço siƒô pobraƒá zawarto≈õci. U≈ºyto danych przyk≈Çadowych.');
        }
        renderContent();
        clearInterval(progressInterval);
        progressBar.style.width = '100%';
        setTimeout(() => contentLoading.classList.remove('active'), 300);
    } catch (error) {
        if (cachedData) {
            apiData = JSON.parse(cachedData);
            showToast('Brak po≈ÇƒÖczenia. U≈ºyto zbuforowanych danych.');
        } else {
            apiData = fallbackData;
            showToast('Brak po≈ÇƒÖczenia. U≈ºyto danych przyk≈Çadowych.');
        }
        renderContent();
        clearInterval(progressInterval);
        progressBar.style.width = '100%';
        setTimeout(() => contentLoading.classList.remove('active'), 300);
        console.error('B≈ÇƒÖd ≈Çadowania tre≈õci:', error);
    }
}

        function renderContent(filter = '') {
            const carousels = {
                live: document.getElementById('liveContent'),
                films: document.getElementById('moviesContent'),
                music: document.getElementById('musicContent'),
                books: document.getElementById('booksContent'),
                recentlyViewed: document.getElementById('recentlyViewedContent')
            };

            let totalResults = 0;
            const searchResults = document.getElementById('searchResults');
            const isFavoritesOnly = localStorage.getItem('favoritesOnly') === 'true';

            // Render Recently Viewed
            const filteredRecent = filter
                ? recentlyViewed.filter(item => item.title.toLowerCase().includes(filter.toLowerCase()))
                : recentlyViewed;
            const visibleRecent = filteredRecent.slice(0, 15);
            carousels.recentlyViewed.innerHTML = visibleRecent.length
                ? visibleRecent.map((item, idx) => {
                    if (isFavoritesOnly && !favorites[item.title]) return '';
                    const highlightedTitle = filter
                        ? item.title.replace(new RegExp(`(${filter})`, 'gi'), '<span class="highlight">$1</span>')
                        : item.title;
                    return `
                        <div class="item" role="button" tabindex="0" aria-label="Otw√≥rz ${sanitizeInput(item.title)} (element ${idx + 1} z ${visibleRecent.length})"
                             data-category="${item.section.slice(0, -1)}" data-item='${JSON.stringify(item)}'>
                            <img src="${sanitizeInput(item.imageUrl)}?w=220" alt="${sanitizeInput(item.title)}" loading="lazy">
                            <button class="favorite ${favorites[item.title] ? 'favorited' : ''}" 
                                    onclick="toggleFavorite('${sanitizeInput(item.title)}')" 
                                    aria-label="${favorites[item.title] ? 'Usu≈Ñ z ulubionych' : 'Dodaj do ulubionych'}">‚ô•</button>
                            <p>${highlightedTitle}</p>
                            <span class="tooltip">${sanitizeInput(item.description || 'Brak opisu')}</span>
                        </div>
                    `;
                }).join('')
                : '<p style="color: var(--text-color); text-align: center;">Brak ostatnio oglƒÖdanych</p>';
            totalResults += visibleRecent.length;
            updateCarouselNav('recentlyViewedContent');

            // Render Main Sections
            Object.entries(apiData).forEach(([section, items]) => {
                if (!carousels[section]) return;

                let filteredItems = filter
                    ? items.filter(item => item.title.toLowerCase().includes(filter.toLowerCase()))
                    : items;
                if (isFavoritesOnly) {
                    filteredItems = filteredItems.filter(item => favorites[item.title]);
                }

                totalResults += filteredItems.length;
                const visibleItems = filteredItems.slice(0, 10);
                carousels[section].innerHTML = visibleItems.length
                    ? visibleItems.map((item, idx) => {
                        if (item.placeholder) {
                            return `
                                <div class="item premium-placeholder" role="button" tabindex="0" aria-label="Tre≈õƒá premium (element ${idx + 1} z ${visibleItems.length})">
                                    <div class="premium-lock">üîí Premium wymagane</div>
                                </div>
                            `;
                        }
                        const highlightedTitle = filter
                            ? item.title.replace(new RegExp(`(${filter})`, 'gi'), '<span class="highlight">$1</span>')
                            : item.title;
                        return `
                            <div class="item" role="button" tabindex="0" aria-label="Otw√≥rz ${sanitizeInput(item.title)} (element ${idx + 1} z ${visibleItems.length})"
                                 data-category="${section.slice(0, -1)}" data-item='${JSON.stringify(item)}'>
                                <img src="${sanitizeInput(item.imageUrl)}?w=${section === 'books' ? 140 : 220}" alt="${sanitizeInput(item.title)}" loading="lazy">
                                ${section === 'live' ? '<span class="live-badge">LIVE</span>' : ''}
                                <button class="favorite ${favorites[item.title] ? 'favorited' : ''}" 
                                        onclick="toggleFavorite('${sanitizeInput(item.title)}')" 
                                        aria-label="${favorites[item.title] ? 'Usu≈Ñ z ulubionych' : 'Dodaj do ulubionych'}">‚ô•</button>
                                <p>${highlightedTitle}</p>
                                <span class="tooltip">${sanitizeInput(item.description || 'Brak opisu')}</span>
                            </div>
                        `;
                    }).join('')
                    : '<p style="color: var(--text-color); text-align: center;">Brak wynik√≥w</p>';

                updateCarouselNav(carousels[section].id);
            });

            searchResults.textContent = filter ? `Znaleziono ${totalResults} wynik√≥w` : '';
        }

        function toggleFavorite(title) {
            if (favorites[title]) {
                delete favorites[title];
                showToast('Usuniƒôto z ulubionych');
            } else {
                favorites[title] = true;
                showToast('Dodano do ulubionych');
            }
            localStorage.setItem('favorites', JSON.stringify(favorites));
            renderContent(document.getElementById('searchInput').value);
        }

        function scrollCarousel(carouselId, amount) {
            const carousel = document.getElementById(carouselId);
            requestAnimationFrame(() => {
                carousel.scrollLeft += amount;
                updateCarouselNav(carouselId);
            });
        }

        function updateCarouselNav(carouselId) {
            const carousel = document.getElementById(carouselId);
            const prevBtn = carousel.parentElement.querySelector('.carousel-prev');
            const nextBtn = carousel.parentElement.querySelector('.carousel-next');
            if (prevBtn && nextBtn) {
                prevBtn.disabled = carousel.scrollLeft <= 0;
                nextBtn.disabled = carousel.scrollLeft + carousel.clientWidth >= carousel.scrollWidth;
            }
        }

        async function fetchPDFAsBlob(url) {
            try {
                const response = await fetch(url, { mode: 'cors' });
                if (!response.ok) throw new Error('B≈ÇƒÖd pobierania PDF');
                const blob = await response.blob();
                return URL.createObjectURL(blob);
            } catch (error) {
                console.error('B≈ÇƒÖd pobierania PDF:', error);
                return 'https://mozilla.github.io/pdf.js/web/compressed.tracemonkey-pldi-09.pdf';
            }
        }

        async function openMediaModal(category, item) {
            if (item.placeholder) {
                showToast('Wymagany dostƒôp premium!');
                return;
            }

            const modal = document.getElementById('mediaModal');
            const modalTitle = document.getElementById('modalTitle');
            const mediaPlayer = document.getElementById('mediaPlayer');
            const pdfViewerContainer = document.getElementById('pdfViewerContainer');

            recentlyViewed = recentlyViewed.filter(i => i.title !== item.title);
            recentlyViewed.unshift({ ...item, section: category.toLowerCase() + 's' });
            if (recentlyViewed.length > 5) recentlyViewed.pop();
            localStorage.setItem('recentlyViewed', JSON.stringify(recentlyViewed));

            modalTitle.textContent = sanitizeInput(item.title);
            mediaPlayer.innerHTML = '';
            mediaPlayer.style.display = 'block';
            pdfViewerContainer.style.display = 'none';

            try {
                if (category === 'Film' || category === 'Live') {
                    mediaPlayer.innerHTML = `<iframe src="${sanitizeInput(item.url)}" allowfullscreen></iframe>`;
                } else if (category === 'Muzyka') {
                    mediaPlayer.innerHTML = `
                        <div id="youtubePlayer"></div>
                        <audio controls id="audioPlayer" style="display: none;">
                            <source src="${sanitizeInput(item.url)}" type="audio/mpeg">
                            Brak obs≈Çugi audio.
                        </audio>
                    `;
                    if (item.youtubeId) {
                        new YT.Player('youtubePlayer', {
                            height: '200',
                            width: '100%',
                            videoId: item.youtubeId,
                            playerVars: { 'playsinline': 1, 'controls': 1 }
                        });
                    } else {
                        document.getElementById('audioPlayer').style.display = 'block';
                    }
                } else if (category === 'KsiƒÖ≈ºka') {
                    mediaPlayer.style.display = 'none';
                    pdfViewerContainer.style.display = 'block';
                    document.getElementById('pdfLoadingOverlay').classList.add('active');
                    const pdfUrl = await fetchPDFAsBlob(item.url);
                    loadPDF(pdfUrl);
                }
            } catch (error) {
                showToast('Nie uda≈Ço siƒô za≈Çadowaƒá tre≈õci.');
                console.error('B≈ÇƒÖd otwierania multimedi√≥w:', error);
            }

            modal.style.display = 'flex';
            modal.focus();
            renderContent(document.getElementById('searchInput').value);
        }

        async function loadPDF(url) {
            canvas = document.getElementById('pdfViewer');
            ctx = canvas.getContext('2d');
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';

            try {
                pdfDoc = await pdfjsLib.getDocument(url).promise;
                pageNum = 1;
                renderPage(pageNum);
            } catch (error) {
                document.getElementById('pdfViewerContainer').innerHTML = '<p style="color: #f40612; text-align: center;">Nie uda≈Ço siƒô za≈Çadowaƒá PDF. Spr√≥buj ponownie p√≥≈∫niej.</p>';
                console.error('B≈ÇƒÖd ≈Çadowania PDF:', error);
            } finally {
                document.getElementById('pdfLoadingOverlay').classList.remove('active');
            }
        }

        function renderPage(num) {
            if (!pdfDoc) return;
            pageRendering = true;
            pdfDoc.getPage(num).then(page => {
                const viewport = page.getViewport({ scale: 1.5 });
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                const renderContext = { canvasContext: ctx, viewport };
                const renderTask = page.render(renderContext);

                renderTask.promise.then(() => {
                    pageRendering = false;
                    document.getElementById('pageInfo').textContent = `Strona ${num} z ${pdfDoc.numPages}`;
                    document.querySelectorAll('.pdf-controls button').forEach(btn => btn.disabled = false);
                    if (pageNumPending !== null) {
                        renderPage(pageNumPending);
                        pageNumPending = null;
                    }
                });
            }).catch(error => {
                document.getElementById('pdfViewerContainer').innerHTML = '<p style="color: #f40612; text-align: center;">B≈ÇƒÖd renderowania PDF.</p>';
                document.getElementById('pdfLoadingOverlay').classList.remove('active');
                console.error('B≈ÇƒÖd renderowania strony:', error);
            });
        }

        function previousPage() {
            if (pageNum <= 1 || !pdfDoc) return;
            pageNum--;
            queueRenderPage(pageNum);
        }

        function nextPage() {
            if (pageNum >= pdfDoc.numPages || !pdfDoc) return;
            pageNum++;
            queueRenderPage(pageNum);
        }

        function queueRenderPage(num) {
            if (pageRendering) {
                pageNumPending = num;
            } else {
                renderPage(num);
            }
        }

        function closeModal() {
            const modal = document.getElementById('mediaModal');
            const mediaPlayer = document.getElementById('mediaPlayer');
            const pdfViewerContainer = document.getElementById('pdfViewerContainer');
            modal.style.display = 'none';
            mediaPlayer.innerHTML = '';
            pdfViewerContainer.style.display = 'none';
            pdfViewerContainer.innerHTML = `
                <div class="loading-overlay" id="pdfLoadingOverlay">
                    <div class="loading-spinner"></div>
                </div>
                <canvas id="pdfViewer"></canvas>
                <div class="pdf-controls">
                    <button onclick="previousPage()" aria-label="Poprzednia strona">Poprzednia</button>
                    <span id="pageInfo"></span>
                    <button onclick="nextPage()" aria-label="Nastƒôpna strona">Nastƒôpna</button>
                </div>
            `;
            pdfDoc = null;
            pageNum = 1;
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        function closeProfileModal() {
            document.getElementById('profileModal').style.display = 'none';
        }

        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        function initEventListeners() {
            document.getElementById('avatar').style.display = 'none';

            document.addEventListener('click', (e) => {
                const target = e.target;
                if (target.closest('.item') && !target.closest('.favorite') && !target.closest('.premium-placeholder')) {
                    const item = JSON.parse(target.closest('.item').dataset.item);
                    const category = target.closest('.item').dataset.category;
                    openMediaModal(category, item);
                } else if (target.closest('.premium-placeholder')) {
                    showToast('Wymagany dostƒôp premium!');
                } else if (target.closest('.theme-preview')) {
                    const theme = target.dataset.theme;
                    document.documentElement.setAttribute('data-theme', theme);
                    localStorage.setItem('theme', theme);
                    document.querySelectorAll('.theme-preview').forEach(preview => {
                        preview.classList.toggle('selected', preview.dataset.theme === theme);
                    });
                } else if (!target.closest('.avatar') && !target.closest('.dropdown')) {
                    document.getElementById('dropdown').classList.remove('active');
                } else if (!target.closest('.modal-content') && target.closest('#mediaModal')) {
                    closeModal();
                } else if (!target.closest('.modal-content') && target.closest('#settingsModal')) {
                    closeSettingsModal();
                } else if (!target.closest('.modal-content') && target.closest('#profileModal')) {
                    closeProfileModal();
                }
            });

            document.addEventListener('keydown', (e) => {
                if (e.target.closest('.item') && (e.key === 'Enter' || e.key === ' ')) {
                    e.preventDefault();
                    if (e.target.closest('.premium-placeholder')) {
                        showToast('Wymagany dostƒôp premium!');
                        return;
                    }
                    const item = JSON.parse(e.target.closest('.item').dataset.item);
                    const category = e.target.closest('.item').dataset.category;
                    openMediaModal(category, item);
                } else if (e.key === 'Escape' && document.getElementById('mediaModal').style.display === 'flex') {
                    closeModal();
                } else if (e.key === 'Escape' && document.getElementById('settingsModal').style.display === 'flex') {
                    closeSettingsModal();
                } else if (e.key === 'Escape' && document.getElementById('profileModal').style.display === 'flex') {
                    closeProfileModal();
                } else if (e.key === 'Escape' && document.getElementById('dropdown').classList.contains('active')) {
                    toggleDropdown();
                } else if (e.target.closest('.carousel') && (e.key === 'ArrowRight' || e.key === 'ArrowLeft')) {
                    const carousel = e.target.closest('.carousel');
                    const items = carousel.querySelectorAll('.item, .premium-placeholder');
                    const focusedIndex = Array.from(items).findIndex(item => item === document.activeElement);
                    const nextIndex = e.key === 'ArrowRight' ? focusedIndex + 1 : focusedIndex - 1;
                    if (nextIndex >= 0 && nextIndex < items.length) {
                        items[nextIndex].focus();
                        const itemWidth = carousel.id === 'booksContent' ? 140 : 220;
                        carousel.scrollLeft = nextIndex * (itemWidth + 20) - carousel.clientWidth / 2 + itemWidth / 2;
                    }
                }
            });

            document.getElementById('avatar').addEventListener('click', toggleDropdown);
            document.getElementById('avatar').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    toggleDropdown();
                }
            });

            document.getElementById('username').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') document.getElementById('password').focus();
            });

            document.getElementById('password').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') login();
            });

            document.getElementById('loginButton').addEventListener('click', login);

            document.getElementById('profileForm').addEventListener('submit', saveProfile);

            const renderSearch = debounce(() => {
                renderContent(document.getElementById('searchInput').value);
            }, 300);
            document.getElementById('searchInput').addEventListener('input', renderSearch);

            document.querySelectorAll('.carousel').forEach(carousel => {
                let isScrolling = false;
                const prevBtn = carousel.parentElement.querySelector('.carousel-prev');
                const nextBtn = carousel.parentElement.querySelector('.carousel-next');

                if (prevBtn) {
                    prevBtn.addEventListener('click', () => {
                        scrollCarousel(carousel.id, carousel.id === 'booksContent' ? -140 : -220);
                    });
                }
                if (nextBtn) {
                    nextBtn.addEventListener('click', () => {
                        scrollCarousel(carousel.id, carousel.id === 'booksContent' ? 140 : 220);
                    });
                }

                carousel.addEventListener('keydown', (e) => {
                    if (e.key === 'ArrowRight') {
                        scrollCarousel(carousel.id, carousel.id === 'booksContent' ? 140 : 220);
                    } else if (e.key === 'ArrowLeft') {
                        scrollCarousel(carousel.id, carousel.id === 'booksContent' ? -140 : -220);
                    }
                });

                let startX, scrollLeft;
                carousel.addEventListener('touchstart', (e) => {
                    startX = e.touches[0].pageX;
                    scrollLeft = carousel.scrollLeft;
                });

                carousel.addEventListener('touchmove', (e) => {
                    if (isScrolling) return;
                    const x = e.touches[0].pageX;
                    const walk = (startX - x) * 2;
                    carousel.scrollLeft = scrollLeft + walk;
                });

                carousel.addEventListener('scroll', () => {
                    isScrolling = true;
                    updateCarouselNav(carousel.id);
                    clearTimeout(carousel.scrollTimeout);
                    carousel.scrollTimeout = setTimeout(() => {
                        isScrolling = false;
                    }, 150);
                });
            });

            document.getElementById('dropdown').addEventListener('click', (e) => {
                if (e.target.textContent === 'Profil') {
                    openProfileModal();
                } else if (e.target.textContent === 'Ustawienia') {
                    openSettingsModal();
                } else if (e.target.textContent === 'Ulubione') {
                    showFavorites();
                } else if (e.target.textContent === 'Wyloguj') {
                    logout();
                }
            });

            document.getElementById('settingsModal').querySelector('.close-btn').addEventListener('click', closeSettingsModal);
            const mediaModalCloseBtn = document.getElementById('mediaModal').querySelector('.close-btn');
            if (mediaModalCloseBtn) mediaModalCloseBtn.addEventListener('click', closeModal);

            document.getElementById('profileModal').querySelector('.close-btn').addEventListener('click', closeProfileModal);

            document.getElementById('compactView').addEventListener('change', (e) => {
                const view = e.target.checked ? 'compact' : 'full';
                document.documentElement.setAttribute('data-view', view);
                localStorage.setItem('view', view);
                renderContent(document.getElementById('searchInput').value);
            });

            document.getElementById('favoritesOnly').addEventListener('change', (e) => {
                localStorage.setItem('favoritesOnly', e.target.checked);
                renderContent(document.getElementById('searchInput').value);
            });

            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);

            const savedView = localStorage.getItem('view') || 'full';
            document.documentElement.setAttribute('data-view', savedView);
        }

        initEventListeners();
    </script>
</body>
</html>